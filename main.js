(()=>{"use strict";const e={formSelector:".form",inputSelector:".form__input",submitButtonSelector:".form__save",inactiveButtonClass:"form__save_inactive",inputErrorClass:"form__input_type_error",errorClass:"form__input-error_active"},t=document.querySelector("#profile-edit"),s=document.querySelector(".profile__avatar-edit"),i=document.querySelector(".profile__add-button"),r=document.querySelector(".popup-edit"),n=document.querySelector(".popup-add"),o=document.querySelector(".popup-avatar-update"),a=document.querySelector("#input-name"),l=document.querySelector("#input-job"),c=(document.querySelector("#input-place-name"),document.querySelector("#input-image-link"),document.querySelector(".edit-form"),document.querySelector(".add-form"),document.querySelector(".template-card"),document.querySelector(".cards__list"));class h{constructor(e,t){let{item:s,handleCardClick:i,handleDeleteClick:r,handleLikeClick:n,handleDeleteLike:o,userId:a}=e;this._title=s.name,this._link=s.link,this._cardId=s.id,this._item=s,this._handleCardClick=i,this._handleDeleteClick=r,this._cardSelector=t,this._handleLikeClick=n,this._handleDeleteLike=o,this._likes=s.likes,this._userId=a}_getTemplate(){return document.querySelector(this._cardSelector).content.querySelector(".cards__item").cloneNode(!0)}deleteCard(){this._element.remove(),this._element=null}_toggleLike(){this._element.querySelector(".cards__like-button").classList.toggle("cards__like-button-active")}setLikeCount(e){this._element.querySelector(".cards__like-counter").textContent=e.likes.length}_like(e){this._toggleLike(),this._handleLikeClick(e)}_dislike(e){this._toggleLike(),this._handleDeleteLike(e)}_addTaskListeners(){this._element.querySelector(".cards__delete-button").addEventListener("click",(()=>this._handleDeleteClick(this._userId))),this._element.querySelector(".cards__like-button").addEventListener("click",(()=>{this._element.querySelector(".cards__like-button").classList.contains("cards__like-button-active")?this._dislike(this._item):this._like(this._item)})),this._element.querySelector(".cards__image").addEventListener("click",(()=>this._handleCardClick(this._title,this._link)))}_checkLikedState(){this._item.likes.forEach((e=>{e._id===this._userId&&this._toggleLike()}))}generateCard(){this._element=this._getTemplate();const e=this._element.querySelector(".cards__image");return this._element.querySelector(".cards__title").textContent=this._title,e.src=this._link,e.alt=this._title,this._item.owner._id===this._userId?this._element.querySelector(".cards__delete-button").style.display="block":this._element.querySelector(".cards__delete-button").style.display="none",this.setLikeCount(this._item),this._addTaskListeners(),this._checkLikedState(),this._element}}class d{constructor(e,t){this._form=t,this._inputSelector=e.inputSelector,this._button=this._form.querySelector(e.submitButtonSelector),this._data=e,this._inputList=Array.from(this._form.querySelectorAll(this._inputSelector))}_hasInvalidInput(){return this._inputList.some((e=>!e.validity.valid))}_toggleButtonState(){this._hasInvalidInput()?(this._button.classList.add(this._data.inactiveButtonClass),this._button.disabled=!0):(this._button.classList.remove(this._data.inactiveButtonClass),this._button.disabled=!1)}_showInputError(e,t){const s=this._form.querySelector(".".concat(e.id,"-error"));e.classList.add(this._data.inputErrorClass),s.textContent=t,s.classList.add(this._data.errorClass)}_hideInputError(e){const t=this._form.querySelector(".".concat(e.id,"-error"));e.classList.remove(this._data.inputErrorClass),t.classList.remove(this._data.errorClass),t.textContent=""}_checkInputValidity(e){e.validity.valid?this._hideInputError(e):this._showInputError(e,e.validationMessage)}_setInputListeners(){this._inputList.forEach((e=>{e.addEventListener("input",(()=>{this._checkInputValidity(e),this._toggleButtonState()}))}))}enableValidation(){this._form.addEventListener("submit",(e=>e.preventDefault())),this._setInputListeners()}checkFormStateOnOpen(){this._inputList.forEach((e=>{this._hideInputError(e)})),this._toggleButtonState()}}class u{constructor(e){var t,s;s=e=>{"Escape"===e.key&&this.close()},(t="_handleEscClose")in this?Object.defineProperty(this,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):this[t]=s,this._popup=document.querySelector(e),this._popupCloseButton=this._popup.querySelector(".popup__close")}open(){this._popup.classList.add("popup_is-opened"),document.addEventListener("keyup",this._handleEscClose)}close(){this._popup.classList.remove("popup_is-opened"),document.removeEventListener("keyup",this._handleEscClose)}_handleMouseClickOutside(e){e.target.matches(".popup_is-opened")&&this.close()}setEventListeners(){this._popup.addEventListener("click",(e=>this._handleMouseClickOutside(e))),this._popupCloseButton.addEventListener("click",(()=>this.close()))}}class _ extends u{constructor(e,t){let{handleFormSubmit:s}=t;super(e),this._handleFormSubmit=s,this._form=this._popup.querySelector(".form"),this._submitButton=this._form.querySelector(".form__save"),this._submitButtonText=this._submitButton.textContent,this._inputList=this._form.querySelectorAll(".form__input")}toggleLoadingMsg(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"Сохранение...";this._submitButton.textContent=e?t:this._submitButtonText}getInputValues(){return this._formValues={},this._inputList.forEach((e=>this._formValues[e.name]=e.value)),this._formValues}_formSubmit(e){e.preventDefault(),this._handleFormSubmit(this.getInputValues())}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",this._formSubmit.bind(this))}close(){super.close(),this._form.reset()}}let p;const m=new class{constructor(e){this._url=e.url,this._headers=e.headers}_handleServerResponse(e){return e.ok?e.json():Promise.reject("Произошла ошибка - ".concat(e.status))}getCards(){return fetch("".concat(this._url,"cards"),{method:"GET",headers:this._headers}).then(this._handleServerResponse)}getUserInfo(){return fetch("".concat(this._url,"users/me"),{headers:this._headers,method:"GET"}).then(this._handleServerResponse)}setUserInfo(e){return fetch("".concat(this._url,"users/me"),{method:"PATCH",headers:this._headers,body:JSON.stringify({name:e.name,about:e.job})}).then(this._handleServerResponse)}loadCard(e){return fetch("".concat(this._url,"cards"),{method:"POST",headers:this._headers,body:JSON.stringify({name:e.place,link:e.link})}).then(this._handleServerResponse)}deleteCard(e){return fetch("".concat(this._url,"cards/").concat(e),{method:"DELETE",headers:this._headers}).then(this._handleServerResponse)}putLike(e){return fetch("".concat(this._url,"cards/likes/").concat(e),{method:"PUT",headers:this._headers}).then(this._handleServerResponse)}deleteLike(e){return fetch("".concat(this._url,"cards/likes/").concat(e),{method:"DELETE",headers:this._headers}).then(this._handleServerResponse)}setAvatar(e){return fetch("".concat(this._url,"users/me/avatar"),{method:"PATCH",headers:this._headers,body:JSON.stringify({avatar:e})}).then(this._handleServerResponse)}}({url:"https://mesto.nomoreparties.co/v1/cohort-23/",headers:{Authorization:"fd203571-6c18-4944-b0cc-56f9f29c5b53","content-type":"application/json"}});Promise.all([m.getCards(),m.getUserInfo()]).then((e=>{let[t,s]=e;p=s._id,L.setUserAvatar(s),L.setUserInfo(s),g.renderItems(t)})).catch((e=>console.log(e)));const v=new class extends u{constructor(e){super(e),this._image=this._popup.querySelector(".popup-image__photo"),this._caption=this._popup.querySelector(".popup-image__figcaption")}open(e){this._image.src=e.link,this._image.alt=e.name,this._caption.textContent=e.name,super.open()}}(".popup-image");v.setEventListeners();const S=new class extends u{constructor(e){super(e),this._button=this._popup.querySelector(".form__save"),this._form=this._popup.querySelector(".form")}setSubmitAction(e){this._handleSubmit=e}setEventListeners(){super.setEventListeners(),this._form.addEventListener("submit",(e=>{e.preventDefault(),this._button.textContent="Удаление...",this._handleSubmit()}))}}(".popup-confirm-delete");S.setEventListeners();const k=e=>{const t=new h({item:e,handleCardClick:()=>{v.open(e)},handleDeleteClick:()=>{S.open(),S.setSubmitAction((()=>{m.deleteCard(e._id).then((e=>{t.deleteCard(e._id),S.close()})).catch((e=>{console.log("Ошибка удаления - ".concat(e))}))}))},handleLikeClick:e=>{m.putLike(e._id).then((e=>{t.setLikeCount(e)})).catch((e=>{console.log('Ошибка установки "лайка" - '.concat(e))}))},handleDeleteLike:e=>{m.deleteLike(e._id).then((e=>{t.setLikeCount(e)})).catch((e=>{console.log('Ошибка удаления "лайка" - '.concat(e))}))},userId:p},".template-card");return t.generateCard()},g=new class{constructor(e,t){let{renderer:s}=e;this._renderer=s,this._container=t}renderItems(e){e.forEach((e=>this._renderer(e)))}addItem(e){this._container.prepend(e)}}({renderer:e=>{const t=k(e);g.addItem(t)}},c),f=new _(".popup-add",{handleFormSubmit:e=>{f.toggleLoadingMsg(!0),m.loadCard(e).then((e=>{g.addItem(k(e)),f.close()})).catch((e=>{console.log(e)})).finally((e=>{f.toggleLoadingMsg(!1)}))}});f.setEventListeners();const L=new class{constructor(e){let{name:t,job:s,avatar:i}=e;this._name=document.querySelector(t),this._job=document.querySelector(s),this._avatar=document.querySelector(i)}getUserInfo(){return{name:this._name.textContent,job:this._job.textContent,avatar:this._avatar.src}}setUserInfo(e){this._name.textContent=e.name,this._job.textContent=e.about,this.setUserAvatar(e)}setUserAvatar(e){this._avatar.src=e.avatar}}({name:".profile__name",job:".profile__job",avatar:".profile__avatar"}),b=new _(".popup-avatar-update",{handleFormSubmit:()=>{b.toggleLoadingMsg(!0);const e=b.getInputValues();m.setAvatar(e.link).then((e=>{L.setUserAvatar(e),b.close()})).catch((e=>{console.log("Ошибка установки нового аватара - ".concat(e))})).finally((()=>{b.toggleLoadingMsg(!1)}))}});b.setEventListeners();const y=new _(".popup-edit",{handleFormSubmit:e=>{y.toggleLoadingMsg(!0);const t=y.getInputValues();m.setUserInfo(t).then((e=>{L.setUserInfo(e),y.close()})).catch((e=>{console.log(e)})).finally((()=>{y.toggleLoadingMsg(!1)}))}});y.setEventListeners(),s.addEventListener("click",(()=>{b.open(),q.checkFormStateOnOpen()})),t.addEventListener("click",(()=>{const e=L.getUserInfo();a.value=e.name,l.value=e.job,y.open(),C.checkFormStateOnOpen()})),i.addEventListener("click",(()=>{f.open(),E.checkFormStateOnOpen()}));const C=new d(e,r),E=new d(e,n),q=new d(e,o);C.enableValidation(),E.enableValidation(),q.enableValidation()})();